#!/bin/bash

# --- 配置路径 ---
RES_DIR="res"
ICO_SRC="$RES_DIR/favicon.svg"
BIB_SRC="$RES_DIR/works.bib"
BIB_OUT="$RES_DIR/works.yml"
LIB_DIR="lib"
OUT_DIR="output"
RELOAD_SIGNAL="$OUT_DIR/.reload"

mkdir -p "$OUT_DIR"

# --- 1. 生成 Base64 图标变量 ---
if [ -f "$ICO_SRC" ]; then
    # macOS 和 Linux 的 base64 参数略有不同，这里做一个简单的兼容处理
    if [[ "$OSTYPE" == "darwin"* ]]; then
        ICON_B64=$(base64 -i "$ICO_SRC")
    else
        ICON_B64=$(base64 -w 0 "$ICO_SRC")
    fi
    ICO_TAG="<link rel=\"icon\" type=\"image/svg+xml\" href=\"data:image/svg+xml;base64,$ICON_B64\">"
else
    ICO_TAG="" # 如果找不到文件，则不注入
fi

# --- 1. 参考文献转换 ---
update_bib() {
    if [ -f "$BIB_SRC" ]; then
        if [ ! -f "$BIB_OUT" ] || [ "$BIB_SRC" -nt "$BIB_OUT" ]; then
            echo "[BIB] 更新文献库..."
            hayagriva "$BIB_SRC" > "$BIB_OUT"
            return 0
        fi
    fi
    return 1
}

# --- 2. 编译函数 ---

# 专供 CV 编译 (PDF + 可选的刷新容器)
compile_cv() {
    local mode=$1
    echo "[TYPST] 独立编译 CV -> PDF"
    typst compile "cv.typ" "$OUT_DIR/cv.pdf"
    
    cat > "$OUT_DIR/cv.html" <<EOF
<!DOCTYPE html>
<html>
<head>
    <title>CV Preview</title>
    $ICO_TAG
    <link rel="stylesheet" href="/assets/cv.css">
</head>
<body>
    <embed src="/cv.pdf" type="application/pdf" id="pdf">
EOF

    if [ "$mode" == "watch" ]; then
        cat >> "$OUT_DIR/cv.html" <<'EOF'
    <script>
        let v = '';
        setInterval(() => {
            fetch('/.reload').then(r => r.text()).then(nv => {
                if (v && nv !== v) {
                    const el = document.getElementById('pdf');
                    el.src = '/cv.pdf?t=' + Date.now();
                }
                v = nv;
            }).catch(() => {});
        }, 1000);
    </script>
EOF
    fi
    echo "</body></html>" >> "$OUT_DIR/cv.html"
}

# 专供 Main 编译 (HTML)
compile_main() {
    echo "[TYPST] 编译主页 -> index.html"
    typst compile "main.typ" "$OUT_DIR/index.html" --input target=html --features html
    inject_reload_js "$OUT_DIR/index.html"
}

# 通用 HTML 编译
compile_generic() {
    local f=$1
    local mode=$2
    local out="${f%.typ}.html"
    echo "[TYPST] 编译 HTML: $f"
    typst compile "$f" "$OUT_DIR/$out" --input target=html --features html
    
    # 注入 Favicon
    inject_favicon "$OUT_DIR/$out"
    
    [ "$mode" == "watch" ] && inject_reload_js "$OUT_DIR/$out"
}

inject_favicon() {
    local target=$1
    # 在 </head> 结束前插入
    perl -i -pe "s|<\/head>|\t$ICO_TAG\n\t<\/head>|g" "$target"
}

inject_reload_js() {
    local target=$1
    # JS 内部使用单引号，避免与 perl/shell 冲突
    local js="<script>let v='';setInterval(()=>{fetch('/.reload').then(r=>r.text()).then(nv=>{if(v&&nv!==v)location.reload();v=nv;}).catch(()=>{});},1000);</script>"
    perl -i -pe "s|</body>|$js</body>|g" "$target"
}

trigger_reload() {
    date +%s > "$RELOAD_SIGNAL"
}

get_project_state() {
    stat -c %Y *.typ "$BIB_SRC" "$LIB_DIR"/* 2>/dev/null || stat -f %m *.typ "$BIB_SRC" "$LIB_DIR"/* 2>/dev/null
}

# --- 3. 执行逻辑 ---

case "$1" in
    update)
        rm -f "$RELOAD_SIGNAL"
        update_bib
        [ -f "main.typ" ] && compile_main "clean"
        [ -f "cv.typ" ] && compile_cv "clean"
        for f in *.typ; do
            if [[ "$f" != "main.typ" && "$f" != "cv.typ" ]]; then
                compile_generic "$f" "clean"
            fi
        done
        echo "[DONE] 干净的构建已完成"
        ;;
    
    watch)
        echo "[SERVER] http://localhost:3000 | CV: /cv.html"
        python3 -m http.server 3000 --directory "$OUT_DIR" > /dev/null 2>&1 &
        SERVER_PID=$!
        trap "kill $SERVER_PID; rm -f $RELOAD_SIGNAL; exit" SIGINT SIGTERM

        # 初始编译
        update_bib
        [ -f "main.typ" ] && compile_main "watch"
        [ -f "cv.typ" ] && compile_cv "watch"
        for f in *.typ; do
            if [[ "$f" != "main.typ" && "$f" != "cv.typ" ]]; then
                compile_generic "$f" "watch"
            fi
        done
        trigger_reload
        
        last_state=$(get_project_state)

        while true; do
            sleep 1
            current_state=$(get_project_state)
            if [ "$current_state" != "$last_state" ]; then
                changed=false
                if update_bib; then
                    [ -f "main.typ" ] && compile_main "watch"
                    [ -f "cv.typ" ] && compile_cv "watch"
                    for f in *.typ; do
                        if [[ "$f" != "main.typ" && "$f" != "cv.typ" ]]; then
                            compile_generic "$f" "watch"
                        fi
                    done
                    changed=true
                else
                    for lib_f in "$LIB_DIR"/*; do
                        if [ -f "$lib_f" ] && [ "$lib_f" -nt "$OUT_DIR/index.html" ]; then
                            compile_main "watch"; changed=true; break
                        fi
                    done
                    [ "cv.typ" -nt "$OUT_DIR/cv.pdf" ] && compile_cv "watch" && changed=true
                    [ "main.typ" -nt "$OUT_DIR/index.html" ] && compile_main "watch" && changed=true
                    for f in *.typ; do
                        if [[ "$f" != "main.typ" && "$f" != "cv.typ" ]]; then
                            [ "$f" -nt "$OUT_DIR/${f%.typ}.html" ] && compile_generic "$f" "watch" && changed=true
                        fi
                    done
                fi
                [ "$changed" = true ] && trigger_reload
                last_state="$current_state"
            fi
        done
        ;;
    *)
        echo "Usage: $0 {update|watch}"
        exit 1
        ;;
esac